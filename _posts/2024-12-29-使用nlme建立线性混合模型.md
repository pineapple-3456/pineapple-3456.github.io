---
layout: post
title: 毕业论文笔记1｜使用nlme建立线性混合模型
date: 2024-12-29 
description: 使用nlme建立线性混合模型
tags: 心理学
categories: 
related_posts: true
---

# 线性混合模型介绍

社会科学研究中的数据经常具有层次结构，过去分析层次结构数据容易产生的一个问题是汇总偏差，即将不同组织的数据错误地纳入同一个模型中。例如对不同学校的学生的调查显示，学生的某种特质X可能会影响到学习成绩Y，然而X对Y的回归系数却不是恒定的，而是在不同学校间存在有统计意义的差异。线性混合模型的出现就是为了应对这种问题。应对的策略是允许X对Y的回归系数在一定范围内变化。

考虑以上的以上的例子，使用普通的ols回归可以建立回归方程：

$$
\begin{align}
Y_i = \beta_0 + \beta_1X_i + e_i
\end{align}
$$

其中 $$i$$ 代表第 $$i$$ 个学生个体。

混合模型可以允许回归系数在不同学校间有差异，注意(3)和(4)的因变量是(2)的回归系数：

$$
\begin{align}
& Y_{ij} = \beta_{0j} + \beta_{1j}X_{ij} + r_{ij} \\
& \beta_{0j} = \gamma_{00} + u_{0j} \\
& \beta_{1j} = \gamma_{10} + u_{1j}
\end{align}
$$

其中 $$j$$ 表示第 $$j$$ 个学校， $$r_{ij}$$ 表示学生水平的误差， $$u_{0j}$$ 和 $$u_{1j}$$ 表示学校水平在截距和斜率上的误差，即不同学校间截距和斜率的差异。我们将第一行的方程称为层1，代表学生水平，将后两行的方程称为层2，代表学校水平。

如果 $$\beta_0$$ 和 $$\beta_1$$ 还能够被学校特征W预测，那么有

$$
\begin{align}
& Y_{ij} = \beta_{0j} + \beta_{1j}X_{ij} + r_{ij} \\
& \beta_{0j} = \gamma_{00} + \gamma_{01}W_{j} + u_{0j} \\
& \beta_{1j} = \gamma_{10} + \gamma_{11}W_{j} + u_{1j}
\end{align}
$$

我们可以将混合模型进行合并：

$$
\begin{align}
Y_{ij} = \gamma_{00} + \gamma_{10}X_{ij} + \gamma_{01}W_{j} + \gamma_{11}X_{ij}W_{j} + u_{0j} + u_{1j}X_{ij} + r_{ij} 
\end{align}
$$

对应的普通ols回归方程是一个包含X和W交互项的方程：

$$
\begin{align}
Y_i = \beta_0 + \beta_1X_i + \beta_2W_j + \beta_3X_iW_j+ e_i
\end{align}
$$

对比普通ols回归方程，可以发现二者的区别在于原本的误差项 $$e_i$$ 变为 $$u_{0j}+u_{1j}X_{ij}+r_{ij}$$。实际上这正是线性混合模型与一般线性模型的主要区别：线性混合模型允许更加复杂的残差结构，这些残差依赖于 $$u_{0j}$$ 和 $$u_{1j}$$，因此在各学校中是不同的。线性混合模型中，残差被称为随机效应，其中 $$r_{ij}$$ 称为层1残差的随机效应， $$u_{0j}$$ 称为截距的随机效应， $$u_{1j}$$ 称为X的随机效应。相应地，固定效应则是合并模型(9)中的系数，其中 $$\gamma_{00}$$ 是截距的固定效应， $$\gamma_{10}$$ 是X的固定效应， $$\gamma_{01}$$ 是W的固定效应， $$\gamma_{11}$$ 是X和W交互项的固定效应。熟悉随机效应和固定效应的含义有助于理解nlme的公式设定和结果。

对于固定效应，我们关注的是它的系数，而对于随机效应，我们关注随机效应的方差和协方差。层1随机效应的方差记为 $$\mathrm{Var}(r_{ij}) = \sigma^2$$，层2随机效应协方差记为：

$$
\left.\mathrm{Var}\left[
\begin{array}
{c}u_{0j} \\
 \\
u_{1j}
\end{array}\right.\right]=
\begin{bmatrix}
\tau_{00} & \tau_{01} \\
 \\
\tau_{10} & \tau_{11}
\end{bmatrix}
$$

它们之后会被用来计算方差解释率和各随机效应之间的关系，在后面的实例中可以看到。

# 实例：学生社会经济地位对数学成绩的影响

数据来自刘红云[高级心理统计](http://crup.com.cn/Book/TextDetail?doi=371b74c6-6b77-4f96-9c81-a0acd521f5e9)第十三章13-3.SAV。其中，我们需要用到的变量有：

1. 因变量：mathach学生的数学成绩
2. 自变量：ses社会经济地位
3. 学校编码：id
4. 学校特征：disclim学校纪律环境

```
library(haven) #读sav文件
library(nlme) #拟合线性混合模型

df <- read_sav('/Users/tan/Downloads/高级心理统计/13第十三章 多层线性模型简介/13-3.SAV') #文件导入
```

## 零模型

线性混合模型的建模的一般程序是从简单到复杂，逐步加入变量。最简单的模型被称为零模型，可以为我们提供一些初步的信息，它在层1和层2都只包含截距：

$$
\begin{align}
& Y_{ij}(mathach) = \beta_{0j} + r_{ij} \\
& \beta_{0j} = \gamma_{00} + u_{0j} \\
\end{align}
$$

合并模型为：

$$
\begin{align}
Y_{ij}(mathach) = \gamma_{00} + u_{0j} + r_{ij} 
\end{align}
$$

零模型实际上是一个带随机效应的单因素方差分析模型。包含一个固定效应：
* $$\gamma_{00}$$ 表示总均值

两个随机效应：
* $$u_{0j}$$ 代表学校间差异，方差为 $$\tau_{00}$$。
* $$r_{ij}$$ 代表学生个体差异，方差为 $$\sigma^2$$。

学校间差异和学生个体差异构成了总变异 $$(\tau_{00}+\sigma^2)$$。

计算程序为：

```
hlm_null <- lme(mathach ~ 1, random = ~1|id, data = df, method = 'ML')
summary(hlm_null)
```

程序中lme函数中设置了四个参数。mathach ~ 1 表明固定部分只包含一个截距 $$\gamma_{00}$$， random = ~1\|id 表明随机部分也只包含截距的随机效应 $$u_{0j}$$，依赖于学校id， data = df 表明数据来源， method = 'ML' 表明使用极大似然法进行估计。需要注意：

**估计方法** 线性混合模型一般使用极大似然法(ML)和受限极大似然法(REML)进行估计。ML能够为固定效应提供能准确的估计，REML能够为随机效应提供更准确的估计。多数统计软件默认使用REML估计，本例在原教材中呈现的结果也是使用REML得到的，但具体使用哪一种取决于研究目的。需要注意，如果要使用对数似然进行模型比较，则必须使用ML估计，否则对数似然是没有意义的。

**缺失值处理** 有缺失值时无法计算，可以在参数中加入 na.action = na.exclude，表明忽略缺失值。

计算的结果为：

```
Linear mixed-effects model fit by maximum likelihood
  Data: df 
       AIC      BIC    logLik
  47121.81 47142.45 -23557.91

Random effects:
 Formula: ~1 | id
        (Intercept) Residual
StdDev:    2.924631 6.256868

Fixed effects:  mathach ~ 1 
               Value Std.Error   DF  t-value p-value
(Intercept) 12.63707 0.2436341 7025 51.86905       0

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-3.06261750 -0.75364533  0.02675559  0.76070101  2.74183819 

Number of Observations: 7185
Number of Groups: 160 
```

结果首先给出了整个模型的信息准则AIC和BIC，越小代表拟合效果越好。logLik代表对数似然LL，越大代表拟合效果越好（随后我们要使用-2LL进行模型比较）。在随机部分，给出了两个随机效应的标准差，截距随机效应 $$u_{0j}$$ 的标准差 $$\sqrt{\tau_{00}}$$ 为2.924631，残差 $$r_{ij}$$ 的标准差 $$\sigma$$ 为6.256868。固定效应部分给出截距固定效应 $$\gamma_{00}$$ 为12.63707。

结果没有给出方差，可以使用标准差的平方来计算，也可以使用VarCorr()函数直接提取方差成分：

```
VarCorr(hlm_null)
```

```
id = pdLogChol(1) 
            Variance  StdDev  
(Intercept)  8.553464 2.924631
Residual    39.148400 6.256868
```
表明残差方差 $$\sigma^2$$ 为39.148400，截距方差 $$\tau_{00}$$ 为8.553464。

**ICC系数** 零模型的一个重要作用是计算ICC系数。ICC系数是指组间方差对总方差的解释率： $$\tau_{00}/(\tau_{00}+\sigma^2)$$。ICC系数足够大，表明将模型分为学校和学生两个层次是合理的，一般认为ICC不应该低于0.059。可以提取方差来计算ICC系数：

```
var_comp_null <- VarCorr(hlm_null) #输出方差成分
var_null_l2 <- as.numeric(var_comp_null['(Intercept)', 'Variance'])#提取组间方差
var_null_l1 <- as.numeric(var_comp_null['Residual', 'Variance']) #提取组内方差
icc = var_null_l2/(var_null_l2 + var_null_l1) 
print(icc)
```

```
[1] 0.1793109
```

或者直接使用reghelper包的ICC()函数来计算：

```
library(reghelper)
ICC(hlm_null)
```

```
[1] 0.1793109
```

总而言之，零模型为我们提供了分层数据的初步信息：

1. 对总平均数的估计 $$\gamma_{00}$$
2. 学校间方差 $$\tau_{00}$$
3. 学生个体间方差 $$\sigma^2$$
4. 学校间方差对总方差的解释率 ICC系数

## 随机斜率模型

在零模型的基础上，使层1包含预测变量ses，并且允许ses的斜率带有随机效应，就构成了随机斜率模型：

$$
\begin{align}
& Y_{ij}(mathach) = \beta_{0j} + \beta_{1j}X_{ij}(ses) + r_{ij} \\
& \beta_{0j} = \gamma_{00} + u_{0j} \\
& \beta_{1j} = \gamma_{10} + u_{1j}
\end{align}
$$

合并模型为：

$$
\begin{align}
Y_{ij}(mathach) = \gamma_{00} + \gamma_{10}X_{ij}(ses) + u_{0j} + u_{1j}X_{ij}(ses) + r_{ij} \\
\end{align}
$$

包含两个固定效应：

* $$\gamma_{00}$$ 表示控制ses后各学校的调整均值
* $$\gamma_{10}$$ 表示各学校ses斜率的均值

三个随机效应：

* $$u_{0j}$$ 表示调整均值的学校间差异，方差为 $$\tau_{00}$$。
* $$u_{1j}$$ 表示各学校间ses斜率的差异，方差为 $$\tau_{10}$$。
* $$r_{ij}$$ 表示ses无法解释的学生个体差异，方差为 $$\sigma^2$$。 

计算程序为：

```
hlm_radom_slope <- lme(mathach ~ 1 + ses, random = ~1 + ses|id, data = df, method = 'ML')
summary(hlm_radom_slope)
```
与零模型相比，固定部分中加入了预测变量ses，同时在随机部分中也加入了ses斜率的随机效应。参数估计同样使用极大似然法。需要注意：

**自变量对中** 对中是指将自变量减去其均值，使均值变为0。这是为了使截距变得有意义，当自变量均值为0时，对应的回归预测值就是因变量的均值。考虑上面的随机斜率模型，当自变量以总均值对中后， $$\beta_{0j}$$ 是层1学生水平的均值，相应地，层2 $$\gamma_{00}$$ 为各学校的均值，否则这两个参数会变得难以解释。截距的意义在混合模型中是一个重要问题，尤其是当截距能被学校特征预测时，如果截距无法解释，那么截距预测变量的斜率也没有意义，因此对中是一个必要的步骤。对中有两种方式：以总均值对中和以组均值对中。本例中的自变量是已经进行过标准化的，可以看做以总均值对中。

以总均值对中后，层1模型变为:

$$
\begin{align}
Y_{ij} = \beta_{0j} + \beta_{1j}(X_{ij}-\bar{X}_{..}) + r_{ij}
\end{align}
$$

当 $$X = \bar{X}_{.j}$$ 时，带入能够得到因变量的组均值:

$$
\begin{align}
\beta_{0j} = \bar{Y}_{.j} - \beta_{1j}(X_{.j}-\bar{X}_{..})
\end{align}
$$

是每个学校控制了自变量后的调整均值。如果希望在层1控制某些变量，再估计层2效应，那么应该选择以总均值对中，实际研究大部分是这种情况。

以组均值对中后，层1模型变为：

$$
\begin{align}
Y_{ij} = \beta_{0j} + \beta_{1j}(X_{ij}-\bar{X}_{.j}) + r_{ij}
\end{align}
$$

当 $$X = \bar{X}_{.j}$$ 时，带入能够得到因变量的组均值:

$$
\begin{align}
\beta_{0j} = \bar{Y}_{.j}
\end{align}
$$

这样就忽略了自变量的影响，是每个学校的未调整均值。以组均值对中适合于分离个人层次效应和构成效应。构成效应是指，当我们把自变量分为组均值 $$\bar{X}_{.j}$$ 和个体差异 $$(X_{ij}-\bar{X}_{.j})$$ 两个部分时， $$\bar{X}_{.j}$$ 的效应 $$\beta_b$$ 和 $$(X_{ij}-\bar{X}_{.j})$$ 的效应 $$\beta_w$$ 存在差异，导致相同的 $$X_{ij}$$ 在 $$\bar{X}_{.j}$$ 更高的组具有更大的效应。一般是由于组内所有个体有相似的特质，这种特质形成了一定的氛围，从而改变了个体的效应。例如，假设学生ses对数学成绩的影响具有构成效应，当某两个学校的学生具有相同ses时，处于平均ses更高的学校中的学生具有更高的数学成绩。自变量以组均值对中后，再将组均值加入层2作为截距的预测变量，组均值的系数 $$\gamma_{10}$$ 即为构成效应。

随机斜率模型的计算结果为：

```
Linear mixed-effects model fit by maximum likelihood
  Data: df 
       AIC      BIC    logLik
  46648.47 46689.75 -23318.23

Random effects:
 Formula: ~ses | id
 Structure: General positive-definite, Log-Cholesky parametrization
            StdDev    Corr  
(Intercept) 2.1875031 (Intr)
ses         0.6311267 -0.113
Residual    6.0689007       

Fixed effects:  mathach ~ ses 
                Value Std.Error   DF  t-value p-value
(Intercept) 12.665586 0.1891248 7024 66.96947       0
ses          2.394936 0.1177038 7024 20.34713       0
 Correlation: 
    (Intr)
ses -0.046

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-3.12298183 -0.73009458  0.02184146  0.75598096  2.94309203 

Number of Observations: 7185
Number of Groups: 160
```





### 待续



