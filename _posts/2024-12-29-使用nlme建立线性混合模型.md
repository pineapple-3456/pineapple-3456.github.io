---
layout: post
title: 毕业论文笔记1｜使用nlme建立线性混合模型
date: 2024-12-29 
description: 使用nlme建立线性混合模型
tags: 心理学
categories: 
related_posts: true
---

## 线性混合模型介绍

社会科学研究中的数据经常具有层次结构，过去分析层次结构数据容易产生的一个问题是汇总偏差，即将不同组织的数据错误地纳入同一个模型中。例如对不同学校的学生的调查显示，学生的某种特质X可能会影响到学习成绩Y，然而X对Y的回归系数却不是恒定的，而是在不同学校间存在有统计意义的差异。线性混合模型的出现就是为了应对这种问题。应对的策略是允许X对Y的回归系数在一定范围内变化。

考虑以上的以上的例子，使用普通的ols回归可以建立回归方程：

$$
\begin{align}
Y_i = \beta_0 + \beta_1X_i + e_i
\end{align}
$$

其中 $$i$$ 代表第 $$i$$ 个学生个体。

混合模型可以允许回归系数在不同学校间有差异，注意(3)和(4)的因变量是(2)的回归系数：

$$
\begin{align}
& Y_{ij} = \beta_{0j} + \beta_{1j}X_{ij} + r_{ij} \\
& \beta_{0j} = \gamma_{00} + u_{0j} \\
& \beta_{1j} = \gamma_{10} + u_{1j}
\end{align}
$$

其中 $$j$$ 表示第 $$j$$ 个学校， $$r_{ij}$$ 表示学生水平的误差， $$u_{0j}$$ 和 $$u_{1j}$$ 表示学校水平在截距和斜率上的误差，即不同学校间截距和斜率的差异。我们将第一行的方程称为层1，代表学生水平，将后两行的方程称为层2，代表学校水平。如果 $$\beta_0$$ 和 $$\beta_1$$ 还能够被学校特征W预测，那么普通ols回归方程为：

$$
\begin{align}
Y_i = \beta_0 + \beta_1X_i + \beta_2W_j + \beta_3X_iW_j+ e_i
\end{align}
$$

线性混合模型的方程为：

$$
\begin{align}
& Y_{ij} = \beta_{0j} + \beta_{1j}X_{ij} + r_{ij} \\
& \beta_{0j} = \gamma_{00} + \gamma_{01}W_{j} + u_{0j} \\
& \beta_{1j} = \gamma_{10} + \gamma_{11}W_{j} + u_{1j}
\end{align}
$$

合并后的模型为：

$$
\begin{align}
Y_{ij} = \gamma_{00} + \gamma_{10}X_{ij} + \gamma_{01}W_{j} + \gamma_{11}X_{ij}W_{j} + u_{0j} + u_{1j}X_{ij} + r_{ij} 
\end{align}
$$

对比普通ols回归方程，可以发现二者的区别在于原本的误差项 $$e_i$$ 变为 $$u_{0j}+u_{1j}X_{ij}+r_{ij}$$。实际上这正是线性混合模型与一般线性模型的主要区别：线性混合模型允许更加复杂的残差结构，这些残差依赖于 $$u_{0j}$$ 和 $$u_{1j}$$，因此在各学校中是不同的。线性混合模型中，残差被称为随机效应，其中 $$r_{ij}$$ 称为层1残差的随机效应， $$u_{0j}$$ 称为截距的随机效应， $$u_{1j}$$ 称为X的随机效应。相应地，固定效应则是合并模型(9)中的系数，其中 $$\gamma_{00}$$ 是截距的固定效应， $$\gamma_{10}$$ 是X的固定效应， $$\gamma_{01}$$ 是W的固定效应， $$\gamma_{11}$$ 是X和W交互项的固定效应。熟悉随机效应和固定效应的含义有助于理解nlme的公式设定和结果。

对于固定效应，我们关注的是它的系数，而对于随机效应，我们关注随机效应的方差和协方差。层1随机效应的方差记为 $$\mathrm{Var}(r_{ij}) = \sigma^2$$，层2随机效应协方差记为：

$$
\left.\mathrm{Var}\left[
\begin{array}
{c}u_{0j} \\
 \\
u_{1j}
\end{array}\right.\right]=
\begin{bmatrix}
\tau_{00} & \tau_{01} \\
 \\
\tau_{10} & \tau_{11}
\end{bmatrix}
$$

它们之后会被用来计算方差解释率和各随机效应之间的关系，在后面的实例中可以看到。

## 实例：学生社会经济地位对数学成绩的影响

数据来自刘红云[高级心理统计](http://crup.com.cn/Book/TextDetail?doi=371b74c6-6b77-4f96-9c81-a0acd521f5e9)第十三章13-3.SAV。其中，我们需要用到的变量有：

1. 因变量：mathach学生的数学成绩
2. 自变量：ses社会经济地位
3. 学校编码：id
4. 学校特征：disclim学校纪律环境

```
library(haven) #读sav文件
library(nlme) #拟合线性混合模型

df <- read_sav('/Users/tan/Downloads/高级心理统计/13第十三章 多层线性模型简介/13-3.SAV') #文件导入
```

### 零模型

线性混合模型的建模的一般程序是从简单到复杂，逐步加入变量。最简单的模型被称为零模型，可以为我们提供一些初步的信息，它在层1和层2都只包含截距：

$$
\begin{align}
& Y_{ij}(mathach) = \beta_{0j} + r_{ij} \\
& \beta_{0j} = \gamma_{00} + u_{0j} \\
\end{align}
$$

合并模型为：

$$
Y_{ij} = \gamma_{00} + u_{0j} + r_{ij} 
$$

计算程序如下：

```
hlm_null <- lme(mathach ~ 1, random = ~1|id, data = df, method = 'ML')
summary(hlm_null)
```

零模型实际上是一个带随机效应的单因素方差分析模型。层2模型以学校为单位， $$\gamma_{00}$$ 代表总体均值， $$u_{0j}$$ 代表学校间差异。层1以学生为单位， $$r_{ij}$$ 代表学生个体差异，学校间差异和学生个体差异构成了总变异。程序中lme函数中设置了四个参数。mathach ~ 1 表明固定部分只包含一个截距 $$\gamma_{00}$$，random = ~1\|id 表明随机部分也只包含截距的随机效应 $$u_{0j}$$，依赖于学校id，data = df 表明数据来源，method = 'ML' 表明使用极大似然法进行估计。

**估计方法** 线性混合模型一般使用极大似然法(ML)和受限极大似然法(REML)进行估计。ML能够为固定效应提供能准确的估计，REML能够为随机效应提供更准确的估计。多数统计软件默认使用REML估计，本例在原教材中呈现的结果也是使用REML得到的，但具体使用哪一种取决于研究目的。需要注意，如果要使用对数似然进行模型比较，则必须使用ML估计，否则对数似然是没有意义的。

**缺失值处理** 有缺失值时无法计算，可以在参数中加入 na.action = na.exclude，表明忽略缺失值。

计算的结果为：

```
Linear mixed-effects model fit by REML
  Data: df 
       AIC      BIC   logLik
  47122.79 47143.43 -23558.4

Random effects:
 Formula: ~1 | id
        (Intercept) Residual
StdDev:    2.934966 6.256862

Fixed effects:  mathach ~ 1 
               Value Std.Error   DF  t-value p-value
(Intercept) 12.63697 0.2443936 7025 51.70747       0

Standardized Within-Group Residuals:
        Min          Q1         Med          Q3         Max 
-3.06312473 -0.75387398  0.02670132  0.76062171  2.74262579 

Number of Observations: 7185
Number of Groups: 160 
```

结果首先给出了整个模型的信息准则AIC和BIC，越小代表拟合效果越好。logLik代表对数似然LL，越大代表拟合效果越好，随后我们要使用-2LL进行模型比较。在随机部分，给出了两个随机效应的标准差，截距随机效应 $$u_{0j}$$ 的标准差 $$\sqrt{\tau_{00}}$$ 为2.934966，层1残差随机效应 $$r_{ij}$$ 的标准差 $$\sigma$$ 为6.256862。固定效应部分给出截距固定效应 $$\gamma_{00}$$ 为12.63697。

### 随机斜率模型

**自变量对中** 对中即将数据减去均值，使其均值变为0。对中是为了使截距变得有意义，如果我们在模型中设置了随机截距或截距预测变量来解释截距的变化，那截距就应该是有意义的。一般情况下，我们期望截距是各学校的均值。考虑上面的随机斜率模型， $$\beta_{0j}$$ 应该是总体均值，在层1模型中，截距代表自变量为0时所对应的因变量的预测值，

### 待续



